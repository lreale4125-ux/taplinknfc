// db.js - gestione completa del database SQLite 
const Database = require('better-sqlite3');
const bcrypt = require('bcryptjs'); // hashing password

// --- Connessione al database ---
function connectDatabase() {
    let db;
    try {
        db = new Database('./database.db');
        db.pragma('journal_mode = WAL'); // migliore concorrenza
        console.log('✅ Connesso a SQLite (better-sqlite3).');
        return db;
    } catch (err) {
        console.error('❌ ERRORE: impossibile connettersi al database.', err);
        process.exit(1);
    }
}

const db = connectDatabase();

// --- Creazione tabelle principali ---
function createTables() {
    console.log('⏳ Creazione tabelle...');

    db.exec(`
        CREATE TABLE IF NOT EXISTS companies (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL UNIQUE,
            description TEXT,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        );
    `);

    db.exec(`
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            email TEXT UNIQUE NOT NULL,
            password TEXT NOT NULL,
            role TEXT DEFAULT 'user',
            company_id INTEGER,
            balance_tap REAL DEFAULT 0,
            loyalty_points INTEGER DEFAULT 0,
            can_access_wallet INTEGER DEFAULT 1,
            can_access_analytics INTEGER DEFAULT 0,
            can_access_pos INTEGER DEFAULT 0,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (company_id) REFERENCES companies(id) ON DELETE SET NULL
        );
    `);

    db.exec(`
        CREATE TABLE IF NOT EXISTS selectors (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL UNIQUE,
            redirect_url TEXT NOT NULL,
            description TEXT,
            created_by INTEGER,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL
        );
    `);

    db.exec(`
        CREATE TABLE IF NOT EXISTS links (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            url TEXT,
            description TEXT,
            company_id INTEGER NOT NULL,
            created_by INTEGER NOT NULL,
            selector_id INTEGER,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (company_id) REFERENCES companies(id) ON DELETE CASCADE,
            FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE CASCADE,
            FOREIGN KEY (selector_id) REFERENCES selectors(id) ON DELETE SET NULL
        );
    `);

    db.exec(`
        CREATE TABLE IF NOT EXISTS keychains (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            link_id INTEGER NOT NULL,
            keychain_number TEXT UNIQUE,
            data TEXT,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
            FOREIGN KEY (link_id) REFERENCES links(id) ON DELETE CASCADE
        );
    `);

    db.exec(`
        CREATE TABLE IF NOT EXISTS analytics (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            keychain_id INTEGER,
            link_id INTEGER NOT NULL,
            ip_address TEXT NOT NULL,
            user_agent TEXT,
            referrer TEXT,
            country TEXT,
            city TEXT,
            os_name TEXT,
            browser_name TEXT,
            device_type TEXT,
            lat REAL,
            lon REAL,
            click_count INTEGER DEFAULT 1 NOT NULL,
            first_seen DATETIME DEFAULT CURRENT_TIMESTAMP,
            last_seen DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (keychain_id) REFERENCES keychains(id) ON DELETE SET NULL,
            FOREIGN KEY (link_id) REFERENCES links(id) ON DELETE CASCADE,
            UNIQUE(link_id, ip_address, keychain_id)
        );
    `);

    db.exec(`
        CREATE TABLE IF NOT EXISTS motivational_analytics (
            keychain_id INTEGER PRIMARY KEY,
            view_count INTEGER DEFAULT 0,
            topic TEXT,
            FOREIGN KEY (keychain_id) REFERENCES keychains(id) ON DELETE CASCADE
        );
    `);

    db.exec(`
        CREATE TABLE IF NOT EXISTS transactions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            tap_change REAL NOT NULL,
            points_change INTEGER DEFAULT 0,
            type TEXT NOT NULL,
            description TEXT,
            timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
        );
    `);

    console.log('✅ Tabelle create.');
}

// --- Migrazioni sicure per DB esistenti ---
function handleMigrations() {
    console.log('⏳ Esecuzione migrazioni...');

    const safeColumns = [
        { table: 'users', column: 'can_access_wallet', type: 'INTEGER DEFAULT 1' },
        { table: 'users', column: 'can_access_analytics', type: 'INTEGER DEFAULT 0' },
        { table: 'users', column: 'can_access_pos', type: 'INTEGER DEFAULT 0' }
    ];

    safeColumns.forEach(({ table, column, type }) => {
        try {
            db.exec(`ALTER TABLE ${table} ADD COLUMN ${column} ${type}`);
        } catch (e) { /* ignora se esiste */ }
    });

    try { db.exec(`ALTER TABLE links ADD COLUMN selector_id INTEGER`); } catch(e) { }
    try { db.exec(`ALTER TABLE motivational_analytics ADD COLUMN topic TEXT`); } catch(e) { }

    try {
        db.exec(`CREATE UNIQUE INDEX IF NOT EXISTS idx_keychain_number ON keychains(keychain_number) WHERE keychain_number IS NOT NULL`);
    } catch (e) { }

    console.log('✅ Migrazioni completate.');
}

// --- Inserimento dati di default ---
function insertDefaultData() {
    console.log('⏳ Inserimento dati di default...');

    try {
        db.prepare(`
            INSERT OR IGNORE INTO companies (id, name, description)
            VALUES (1, 'Default Company', 'Default company for new users')
        `).run();

        const hashedPassword = bcrypt.hashSync('admin123', 10);
        db.prepare(`
            INSERT OR IGNORE INTO users (username, email, password, role, company_id, can_access_wallet, can_access_analytics, can_access_pos)
            VALUES (?, ?, ?, ?, ?, 1, 1, 1)
        `).run('admin', 'admin@example.com', hashedPassword, 'admin', 1);

        console.log('✅ Dati di default inseriti.');
    } catch (err) {
        console.error('❌ Errore inserimento dati di default:', err.message);
    }
}

// --- Inizializzazione completa ---
function initializeDatabase() {
    createTables();
    handleMigrations();
    insertDefaultData();
    console.log('--- Database inizializzato completamente! ---');
}

initializeDatabase();

// --- Esportazione istanza DB ---
module.exports = db;
