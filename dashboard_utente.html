<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFC Analytics Dashboard</title>

    <link href="/output.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix/dist/chartjs-chart-matrix.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card { background-color: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .keychain-item.active { background-color: #eef2ff; border-left-color: #4f46e5; }
        body:not(.auth-checked) #dashboard { display: none; }
        #interactiveMap { height: 100%; min-height: 288px; width: 100%; border-radius: 0.5rem; background-color: #e5e7eb; }
        /* Stile per i pulsanti dei filtri attivi */
        #dateFilters button.active, #timeAggregationFilters button.active {
            background-color: #4f46e5;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1CXSDL1JJ7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-1CXSDL1JJ7');
</script>

    <div id="app" class="min-h-screen">
        <div id="dashboard">
            <header class="bg-white shadow-sm">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-900">TAPLINK Analytics</h1>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm font-medium" id="userGreeting"></span>
                        <a href="./wallet.html" id="walletButton" class="px-4 py-2 text-sm bg-green-100 text-green-700 font-semibold rounded-md hover:bg-green-200 transition">Il Mio Wallet</a>
                        <button id="logoutButton" class="px-4 py-2 text-sm bg-indigo-100 text-indigo-700 font-semibold rounded-md hover:bg-indigo-200 transition">Logout</button>
                    </div>
                </div>
            </header>
            <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="card"><p class="text-sm font-medium text-gray-500">Link Attivi</p><p class="text-3xl font-bold mt-1" id="activeKeysCount">0</p></div>
                    <div class="card"><p class="text-sm font-medium text-gray-500">Click Totali</p><p class="text-3xl font-bold mt-1" id="totalClicksCount">0</p></div>
                    <div class="card"><p class="text-sm font-medium text-gray-500">Visitatori Unici</p><p class="text-3xl font-bold mt-1" id="uniqueVisitorsCount">0</p></div>
                    <div class="card"><p class="text-sm font-medium text-gray-500">Tasso di Click Medio</p><p class="text-3xl font-bold mt-1" id="avgClickRate">0.0</p></div>
                </div>
            
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    <div class="lg:col-span-1 space-y-8">
                        <div class="card">
                            <h2 class="text-lg font-semibold mb-4">I Tuoi Link</h2>
                            <div id="keychainList" class="space-y-3 max-h-[calc(100vh-250px)] overflow-y-auto">
                                </div>
                        </div>
            
                        <div class="card">
                            <h2 class="text-lg font-semibold mb-4">Ultime Attività</h2>
                            <div id="recentActivityList" class="space-y-4 max-h-72 overflow-y-auto">
                                </div>
                        </div>
                    </div>
                    
                    <div class="lg:col-span-2 space-y-8">
                        <div class="card">
                            <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                                <h2 class="text-lg font-semibold">Click nel Tempo <span id="chartTimeTitle" class="text-sm text-gray-500 font-normal"></span></h2>
                                <div class="flex items-center flex-wrap gap-4 text-sm">
                                    <div id="dateFilters" class="flex items-center gap-2">
                                        <button data-range="7" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md transition active">7 Giorni</button>
                                        <button data-range="30" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md transition">30 Giorni</button>
                                    </div>
                                    <div id="timeAggregationFilters" class="flex items-center gap-2 border-l ml-2 pl-4">
                                        <button data-group="day" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md transition active">Giorno</button>
                                        <button data-group="week" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md transition">Settimana</button>
                                        <button data-group="month" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md transition">Mese</button>
                                    </div>
                                </div>
                            </div>
                            <div class="relative h-72"><canvas id="clicksOverTimeChart"></canvas></div>
                        </div>
            
                        <div class="card">
                            <h2 class="text-lg font-semibold mb-4">Attività Oraria <span id="heatmapTimeTitle" class="text-sm text-gray-500 font-normal"></span></h2>
                            <div class="relative h-72"><canvas id="hourlyHeatmapChart"></canvas></div>
                        </div>
                        
                        <div class="card">
                            <h2 class="text-lg font-semibold mb-4">Distribuzione Geografica</h2>
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-6 h-72">
                                <div class="md:col-span-3">
                                    <div id="interactiveMap"></div>
                                </div>
                                <div class="md:col-span-2 overflow-y-auto">
                                    <h3 class="text-sm font-semibold text-gray-600 mb-2">Top Città</h3>
                                    <div id="topCitiesList" class="space-y-2">
                                        </div>
                                </div>
                            </div>
                        </div>
                    </div>
            
                </div>
            </main>
        </div>
    </div>

    <script>
        // --- SELETTORI E VARIABILI GLOBALI ---
        const userGreeting = document.getElementById('userGreeting');
        const activeKeysCountEl = document.getElementById('activeKeysCount');
        const totalClicksCountEl = document.getElementById('totalClicksCount');
        const uniqueVisitorsCountEl = document.getElementById('uniqueVisitorsCount');
        const avgClickRateEl = document.getElementById('avgClickRate');
        const keychainListEl = document.getElementById('keychainList');
        
        // Selettori per filtri e titoli dei grafici
        const dateFilters = document.getElementById('dateFilters');
        const timeAggregationFilters = document.getElementById('timeAggregationFilters');
        const chartTimeTitleEl = document.getElementById('chartTimeTitle');
        const heatmapTimeTitleEl = document.getElementById('heatmapTimeTitle');
    
        const API_BASE_URL = '';
        let clicksChart, heatmapChart, mapInstance = null;
        
        // Variabili per gestire lo stato corrente dei filtri
        let currentLinkId = null;
        let currentGroupBy = 'day';
        let currentRange = 7;
    
        // --- FUNZIONE DI FETCH UNIFICATA ---
        async function apiFetch(endpoint, options = {}) {
            const token = localStorage.getItem('authToken');
            const headers = { 'Content-Type': 'application/json', ...options.headers };
            if (token) headers['Authorization'] = `Bearer ${token}`;
            
            const response = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });
            
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    localStorage.clear();
                    window.location.href = './index.html';
                }
                const data = await response.json().catch(() => ({ error: `Errore HTTP ${response.status}` }));
                throw new Error(data.error || `Errore ${response.status}`);
            }
            return response.json();
        }
        
        // --- GESTIONE AUTENTICAZIONE E INIZIALIZZAZIONE ---
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('authToken');
            const user = JSON.parse(localStorage.getItem('userData'));

            // ... (la tua logica di controllo del token e del ruolo rimane qui) ...
            if (!token || !user || user.role === 'admin') {
                localStorage.clear();
                window.location.href = './index.html';
                return;
            }
            
            // ++ AGGIUNGI QUESTO BLOCCO DI CODICE ++
            // Controlla se l'utente può accedere al wallet e nasconde il pulsante se non può
            const walletButton = document.getElementById('walletButton');
            if (!user.can_access_wallet || user.can_access_wallet == 0) {
                walletButton.style.display = 'none';
            }
            // ++ FINE DEL BLOCCO DA AGGIUNGERE ++

            document.body.classList.add('auth-checked');
            userGreeting.textContent = `Ciao, ${user.username}!`;

            // Il resto della funzione (initializeFilters, loadUserDashboard, etc.) rimane invariato
            initializeFilters();
            loadUserDashboard();
        });

        document.getElementById('logoutButton').addEventListener('click', () => {
            localStorage.clear();
            window.location.href = './index.html';
        });
        
        // --- FUNZIONI CORE DELLA DASHBOARD ---
        async function loadUserDashboard() {
            try {
                const { links } = await apiFetch('/api/user/links');
    
                const totalClicks = links.reduce((sum, link) => sum + link.total_clicks, 0);
                const uniqueVisitors = links.reduce((sum, link) => sum + link.unique_visitors, 0);
    
                activeKeysCountEl.textContent = links.length;
                totalClicksCountEl.textContent = totalClicks.toLocaleString('it-IT');
                uniqueVisitorsCountEl.textContent = uniqueVisitors.toLocaleString('it-IT');
                avgClickRateEl.textContent = uniqueVisitors > 0 ? (totalClicks / uniqueVisitors).toFixed(1) : '0.0';
    
                renderKeychainList(links);
                
                if (links.length > 0) {
                    await refreshAllAnalytics(links[0].id);
                } else {
                    // Gestisci stato vuoto
                    chartTimeTitleEl.textContent = '';
                    heatmapTimeTitleEl.textContent = '';
                    document.getElementById('recentActivityList').innerHTML = `<p class="text-sm text-gray-500">Nessuna attività da mostrare.</p>`;
                    renderClicksOverTimeChart([], '', '', 'day');
                    renderHeatmapChart([]);
                    renderInteractiveMap([]);
                }
            } catch(e) { 
                console.error(e);
                alert('Impossibile caricare i dati della dashboard.'); 
            }
        }
        
        function renderKeychainList(links) {
            keychainListEl.innerHTML = '';
            if (links.length === 0) {
                keychainListEl.innerHTML = `<p class="text-sm text-gray-500">Nessun link trovato.</p>`;
                return;
            }
            links.forEach(link => {
                const item = document.createElement('div');
                item.className = 'keychain-item p-4 border-l-4 border-gray-200 rounded-r-md cursor-pointer hover:bg-gray-100 transition';
                item.dataset.linkId = link.id;
                item.innerHTML = `
                    <div class="flex justify-between items-center">
                        <p class="font-semibold text-gray-800">${link.name}</p>
                        <span class="text-xs font-bold px-2 py-1 rounded-full bg-indigo-100 text-indigo-700">Attivo</span>
                    </div>
                    <p class="text-sm text-gray-500 mt-1 truncate">${link.url}</p>
                    <div class="flex items-baseline mt-2">
                        <p class="text-2xl font-bold text-gray-900">${link.total_clicks.toLocaleString('it-IT')}</p>
                        <p class="text-xs text-gray-500 ml-1">click totali</p>
                    </div>`;
                item.addEventListener('click', () => refreshAllAnalytics(link.id));
                keychainListEl.appendChild(item);
            });
        }
    
        async function loadLinkAnalytics(linkId, startDate, endDate, groupBy) {
            document.querySelectorAll('.keychain-item').forEach(el => { 
                el.classList.toggle('active', el.dataset.linkId == linkId);
            });
    
            try {
                const query = `?startDate=${startDate}&endDate=${endDate}&groupBy=${groupBy}`;
                const analyticsData = await apiFetch(`/api/user/analytics/${linkId}${query}`);
                const heatmapData = await apiFetch(`/api/user/heatmap/${linkId}?startDate=${startDate}&endDate=${endDate}`);
                
                const linkName = document.querySelector(`.keychain-item[data-link-id='${linkId}'] p.font-semibold`).textContent;
                
                chartTimeTitleEl.textContent = `- ${linkName}`;
                heatmapTimeTitleEl.textContent = `- ${linkName}`;
                
                renderClicksOverTimeChart(analyticsData.clicks_over_time, startDate, endDate, groupBy);
                renderHeatmapChart(heatmapData);
                renderInteractiveMap(analyticsData.recent_activity); 
                renderRecentActivity(analyticsData.recent_activity);
    
            } catch(e) { 
                console.error(e);
                alert(`Impossibile caricare gli analytics per il link ${linkId}.`);
            }
        }
    
        // --- FUNZIONI DI RENDERING DEI GRAFICI E MAPPA ---
        function renderClicksOverTimeChart(data, startDateStr, endDateStr, groupBy) {
            const ctx = document.getElementById('clicksOverTimeChart').getContext('2d');
            if (clicksChart) clicksChart.destroy();
            
            const labels = [];
            const clicksData = [];
            if (!data) return; // Guardia per evitare errori se i dati non arrivano
            const dataMap = new Map(data.map(item => [item.time_group, item.clicks]));
    
            const startDate = new Date(startDateStr + 'T00:00:00Z');
            const endDate = new Date(endDateStr + 'T00:00:00Z');
    
            if (groupBy === 'month') {
                let currentMonth = new Date(Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), 1));
                while (currentMonth <= endDate) {
                    const monthStr = `${currentMonth.getUTCFullYear()}-${(currentMonth.getUTCMonth() + 1).toString().padStart(2, '0')}`;
                    labels.push(currentMonth.toLocaleDateString('it-IT', { month: 'long', year: 'numeric', timeZone: 'UTC' }));
                    clicksData.push(dataMap.get(monthStr) || 0);
                    currentMonth.setUTCMonth(currentMonth.getUTCMonth() + 1);
                }
            } else if (groupBy === 'week') {
                data.forEach(item => {
                    const [year, weekNum] = item.time_group.split('-');
                    labels.push(`Set. ${parseInt(weekNum, 10)}, ${year}`);
                    clicksData.push(item.clicks);
                });
            } else { // 'day'
                let currentDate = new Date(startDate);
                while (currentDate <= endDate) {
                    labels.push(currentDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'short', timeZone: 'UTC' }));
                    const dayStr = currentDate.toISOString().split('T')[0];
                    clicksData.push(dataMap.get(dayStr) || 0);
                    currentDate.setUTCDate(currentDate.getUTCDate() + 1);
                }
            }
            
            clicksChart = new Chart(ctx, { 
                type: 'line', 
                data: { labels, datasets: [{ 
                    label: 'Click', data: clicksData, borderColor: '#4f46e5', backgroundColor: 'rgba(79, 70, 229, 0.1)', 
                    tension: 0.4, fill: true, pointBackgroundColor: '#4f46e5', pointBorderColor: '#fff', pointHoverRadius: 6 
                }] }, 
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }, plugins: { legend: { display: false } } } 
            });
        }
        
        function renderHeatmapChart(data) {
            const ctx = document.getElementById('hourlyHeatmapChart').getContext('2d');
            if (heatmapChart) heatmapChart.destroy();
            if (!data) return; // Guardia per evitare errori se i dati non arrivano
    
            const chartData = data.map(item => ({
                x: parseInt(item.hour_of_day),
                y: (parseInt(item.day_of_week) + 6) % 7,
                v: item.clicks
            }));
            
            const daysOfWeek = ['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato', 'Domenica'];
            const hoursOfDay = Array.from({length: 24}, (_, i) => i.toString().padStart(2, '0'));
    
            heatmapChart = new Chart(ctx, {
                type: 'matrix',
                data: { datasets: [{
                    label: 'Click', data: chartData,
                    backgroundColor: c => {
                        const value = c.dataset.data[c.dataIndex]?.v;
                        if (!value) return 'rgba(230, 230, 240, 0.5)';
                        const alpha = Math.min(0.1 + value / 10, 1.0);
                        return `rgba(79, 70, 229, ${alpha})`;
                    },
                    borderColor: 'rgba(255, 255, 255, 0.5)', borderWidth: 1,
                    width: ({chart}) => (chart.chartArea || {}).width / 24 - 1,
                    height: ({chart}) => (chart.chartArea || {}).height / 7 - 1,
                }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { type: 'category', labels: hoursOfDay, grid: { display: false } }, y: { type: 'category', labels: daysOfWeek, offset: true, grid: { display: false } } },
                    plugins: { legend: { display: false }, tooltip: { callbacks: {
                        title: () => '',
                        label: c => `Click: ${c.raw.v || 0} (${daysOfWeek[c.parsed.y]} - ${hoursOfDay[c.parsed.x]}:00)`
                    }}}
                }
            });
        }
    
        function renderInteractiveMap(analyticsData) {
            const mapContainer = document.getElementById('interactiveMap');
            const listContainer = document.getElementById('topCitiesList');

            if (mapInstance) mapInstance.remove();
            mapInstance = null;
            listContainer.innerHTML = '';

            if (!analyticsData || analyticsData.length === 0) {
                mapContainer.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">Nessun dato geografico</div>';
                listContainer.innerHTML = '<p class="text-sm text-gray-500">Nessuna città da mostrare.</p>';
                return;
            }

            const cityClicks = analyticsData.reduce((acc, item) => {
                const city = item.city;
                // Ignora le città non identificate per non sprecare chiamate API
                if (!city || city === 'Sconosciuta') return acc;
                const country = item.country || 'N/A';
                const key = `${city}, ${country}`;
                if (!acc[key]) acc[key] = { clicks: 0, country: country };
                acc[key].clicks += 1;
                return acc;
            }, {});

            const sortedCities = Object.entries(cityClicks).map(([location, data]) => ({ location, ...data })).sort((a, b) => b.clicks - a.clicks);

            sortedCities.slice(0, 5).forEach(city => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center text-sm';
                item.innerHTML = `<p class="text-gray-700 truncate">${city.location}</p><p class="font-bold text-gray-800">${city.clicks}</p>`;
                listContainer.appendChild(item);
            });

            mapInstance = L.map('interactiveMap').setView([45.0, 9.5], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(mapInstance);

            // ++ MODIFICA CHIAVE: Chiama la TUA API invece di quella esterna ++
            sortedCities.slice(0, 10).forEach(city => {
                // Usa la tua funzione apiFetch per chiamare il tuo nuovo endpoint
                apiFetch(`/api/geocode?q=${encodeURIComponent(city.location)}`)
                    .then(geometry => { // La nostra API restituisce direttamente {lat, lng}
                        if (geometry && geometry.lat && geometry.lng) {
                            L.circle([geometry.lat, geometry.lng], {
                                color: '#4f46e5', fillColor: '#4f46e5', fillOpacity: 0.5,
                                radius: 15000 * Math.sqrt(city.clicks)
                            }).addTo(mapInstance).bindPopup(`<b>${city.location}</b><br>${city.clicks} clicks`);
                        }
                    }).catch(err => console.warn(`Geocoding fallito tramite proxy per ${city.location}:`, err));
            });
        }
    
        function renderRecentActivity(data) {
            const listEl = document.getElementById('recentActivityList');
            listEl.innerHTML = '';
            if (!data || data.length === 0) {
                listEl.innerHTML = `<p class="text-sm text-gray-500">Nessuna attività recente.</p>`;
                return;
            }
    
            const deviceIcons = { mobile: '📱', desktop: '💻', tablet: '📲', sconosciuto: '❓' };
            data.slice(0, 5).forEach(activity => {
                const { os = 'N/A', browser = 'N/A', device = 'Sconosciuto', city = 'Sconosciuto', country = 'N/A', last_seen } = activity;
                const icon = deviceIcons[String(device).toLowerCase()] || deviceIcons['sconosciuto'];
                let deviceInfo = os === 'N/A' && browser === 'N/A' ? 'Dettagli non disponibili' : `${browser} su ${os}`;
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between border-b border-gray-100 py-3';
                item.innerHTML = `
                    <div>
                        <p class="font-medium text-sm">${city}, ${country}</p>
                        <p class="text-xs text-gray-500 mt-1">${icon} ${deviceInfo}</p>
                    </div>
                    <p class="text-xs text-gray-400">${new Date(last_seen).toLocaleTimeString('it-IT', {hour: '2-digit', minute:'2-digit'})}</p>`;
                listEl.appendChild(item);
            });
        }
    
        // --- FUNZIONI UTILITY PER I FILTRI ---
        function initializeFilters() {
            updateFilterStyles(); 
    
            dateFilters.addEventListener('click', e => {
                const target = e.target.closest('button');
                if (!target || !target.dataset.range) return;
                currentRange = parseInt(target.dataset.range, 10);
                updateFilterStyles();
                refreshAllAnalytics();
            });
    
            timeAggregationFilters.addEventListener('click', e => {
                const target = e.target.closest('button');
                if (!target || !target.dataset.group) return;
                currentGroupBy = target.dataset.group;
                updateFilterStyles();
                refreshAllAnalytics();
            });
        }
    
        function updateFilterStyles() {
            document.querySelectorAll('#dateFilters button').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.range, 10) === currentRange);
            });
            document.querySelectorAll('#timeAggregationFilters button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.group === currentGroupBy);
            });
        }
        
        function refreshAllAnalytics(linkId = null) {
            if (linkId) {
                currentLinkId = linkId;
            }
            if (!currentLinkId) return;
            
            const { startDate, endDate } = getDateRange(currentRange);
            loadLinkAnalytics(currentLinkId, startDate, endDate, currentGroupBy);
        }
        
        function getDateRange(days) {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - (days - 1));
            return {
                startDate: startDate.toISOString().split('T')[0],
                endDate: endDate.toISOString().split('T')[0]
            };
        }
    </script>
</body>
</html>