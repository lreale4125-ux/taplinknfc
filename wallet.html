<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TapLink - Wallet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card { background-color: white; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        #qrcode-container img { margin: auto; }
        body:not(.auth-checked) #wallet-content { visibility: hidden; }
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="wallet-content">
        <header class="bg-white shadow-sm">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900">Il Mio Wallet</h1>
                <div>
                    <span id="userGreeting" class="text-sm font-medium mr-4"></span>
                    <button id="logoutButton" class="px-4 py-2 text-sm bg-indigo-100 text-indigo-700 font-semibold rounded-md hover:bg-indigo-200">Logout</button>
                </div>
            </div>
        </header>

        <main class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-1 space-y-8">
                    <div class="card text-center">
                        <p class="text-sm font-medium text-gray-500">Saldo Disponibile</p>
                        <p id="balance-tap" class="text-5xl font-bold text-indigo-600 mt-2">0.00 TAP</p>
                    </div>
                    <div class="card">
                        <h3 class="text-lg font-semibold text-center mb-2">Il Tuo Codice Pagamento</h3>
                        <p class="text-sm text-gray-500 text-center mb-4">Mostra questo codice per pagare.</p>
                        <div id="qrcode-container" class="p-4 bg-gray-50 rounded-lg"></div>
                    </div>
                </div>
                <div class="md:col-span-2 card">
                    <h2 class="text-lg font-semibold mb-4">Storico Transazioni</h2>
                    <div id="transactionsList" class="space-y-3 max-h-[60vh] overflow-y-auto">
                        </div>
                </div>
            </div>
        </main>
    </div>

<script>
    const token = localStorage.getItem('authToken');
    const user = JSON.parse(localStorage.getItem('userData'));

    document.addEventListener('DOMContentLoaded', () => {
        if (!token || !user) {
            localStorage.clear();
            window.location.href = './index.html';
            return;
        }
        document.body.classList.add('auth-checked');
        document.getElementById('userGreeting').textContent = `Ciao, ${user.username}!`;
        loadWalletData();
    });
    
    document.getElementById('logoutButton').addEventListener('click', () => {
        localStorage.clear();
        window.location.href = './index.html';
    });
    
    async function loadWalletData() {
        try {
            const response = await fetch('/api/user/wallet', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Errore nel caricamento del wallet.');
            
            const data = await response.json();
            
            // Popola saldo
            document.getElementById('balance-tap').textContent = `${parseFloat(data.profile.balance_tap || 0).toFixed(2)} TAP`;
            
            // Genera QR Code
            generateQrCode(data.profile.id);

            // Popola transazioni
            renderTransactions(data.transactions);

        } catch (error) {
            alert(error.message);
        }
    }

    function generateQrCode(userId) {
        if (!userId) return;
        const qr = qrcode(4, 'L');
        qr.addData(String(userId));
        qr.make();
        document.getElementById('qrcode-container').innerHTML = qr.createImgTag(5, 4);
    }

    function renderTransactions(transactions) {
        const listEl = document.getElementById('transactionsList');
        listEl.innerHTML = '';
        if (transactions.length === 0) {
            listEl.innerHTML = `<p class="text-sm text-gray-500">Nessuna transazione trovata.</p>`;
            return;
        }
        transactions.forEach(tx => {
            const isPositive = tx.tap_change > 0;
            const item = document.createElement('div');
            item.className = 'text-sm border-b border-gray-100 pb-2';
            item.innerHTML = `
                <div class="flex justify-between items-center">
                    <p class="font-medium truncate pr-2">${tx.description || tx.type}</p>
                    <p class="font-bold whitespace-nowrap ${isPositive ? 'text-green-500' : 'text-red-500'}">
                        ${isPositive ? '+' : ''}${parseFloat(tx.tap_change).toFixed(2)} TAP
                    </p>
                </div>
                <p class="text-xs text-gray-400 mt-1">${new Date(tx.timestamp).toLocaleString('it-IT')}</p>
            `;
            listEl.appendChild(item);
        });
    }
</script>
</body>
</html>